#------------------------------------------------------------------------------
# Settings directly affecting or handled by the pipeline
#------------------------------------------------------------------------------

[pipeline]

# define order of stages to be excecuted one after another, and specify the
# service to use for each of them as stage1:serviceA, stage2:serviceB, ...
order = flux.honda, osc.prob3cpu, aeff.hist, reco.hist, pid.hist

#------------------------------------------------------------------------------
# Binning definitions, linked back to from stage definitions
#------------------------------------------------------------------------------

[binning]

fitter_checks_true.order = true_coszen, true_energy
fitter_checks_true.true_energy = {'num_bins':10, 'is_log':True, 'bin_edges':[  5.01187234,   6.60693448,   8.7096359 ,  11.48153621, 15.13561248,  19.95262315,  26.30267992,  34.67368505, 45.70881896,  60.25595861,  79.43282347] * units.GeV, 'tex': r'E_{\rm true}'}
fitter_checks_true.true_coszen = {'num_bins':10, 'is_lin':True, 'domain':[-1,1], 'tex':r'\cos\,\theta_{Z,{\rm true}}'}

fitter_checks_reco.order = reco_coszen, reco_energy
fitter_checks_reco.reco_energy = {'num_bins':10, 'is_log':True, 'bin_edges':[  5.01187234,   6.60693448,   8.7096359 ,  11.48153621, 15.13561248,  19.95262315,  26.30267992,  34.67368505, 45.70881896,  60.25595861,  79.43282347] * units.GeV, 'tex': r'E_{\rm reco}'}
fitter_checks_reco.reco_coszen = {'num_bins':10, 'is_lin':True, 'domain':[-1,1], 'tex':r'\cos\,\theta_{Z,{\rm reco}}'}

#------------------------------------------------------------------------------
# Flux
#------------------------------------------------------------------------------

[stage.flux]

# instantiation arguments

output_binning = fitter_checks_true
error_method = None
debug_mode = False

# params

# * oversampling
param.oversample_cz = 1
param.oversample_e = 1

# * source data and method
param.flux_file = flux/honda-2015-spl-solmax-aa.d
param.flux_mode = integral-preserving

# * atmospheric index offset
param.atm_delta_index = 0.0 +/- 0.05
param.atm_delta_index.fixed = True
param.atm_delta_index.range = nominal + [-4., +4.] * sigma

# * energy scale
param.energy_scale = 1.0 +/- 0.1
param.energy_scale.fixed = False
param.energy_scale.range = nominal + [-3., +3.] * sigma

# * nu/nubar ratio
param.nu_nubar_ratio = 1.0 +/- 0.1
param.nu_nubar_ratio.fixed = True
param.nu_nubar_ratio.range = nominal + [-3., +3.] * sigma

# * nu_e/nu_mu ratio
param.nue_numu_ratio = 1.0 +/- 0.03
param.nue_numu_ratio.fixed = True
param.nue_numu_ratio.range = nominal + [-10., +10.] * sigma

#------------------------------------------------------------------------------
# Oscillations
#------------------------------------------------------------------------------

[stage.osc]
#include settings/osc/nsi_null.cfg

#include settings/osc/nsi_null.cfg


# instantiation arguments

input_binning = fitter_checks_true
output_binning = fitter_checks_true
error_method = None
debug_mode = False

# params

param.earth_model = osc/PREM_12layer.dat

param.YeI = 0.4656
param.YeM = 0.4957
param.YeO = 0.4656

param.detector_depth = 2. units.km
param.prop_height = 20. units.km

param.theta12 = ${fitter_checks:theta12}
param.theta12.fixed = True

param.theta13 = ${fitter_checks:theta13}
param.theta13.fixed = False
param.theta13.range = [7.85, 9.1] * units.deg

param.theta23 = ${fitter_checks:theta23}
param.theta23.fixed = False
param.theta23.range = [30, 60] * units.deg
param.theta23.prior = uniform

param.deltacp = ${fitter_checks:deltacp}
param.deltacp.fixed = True

param.deltam21 = ${fitter_checks:deltam21}
param.deltam21.fixed = True

param.deltam31 = ${fitter_checks:deltam31}
param.deltam31.fixed = False
param.deltam31.prior = uniform
param.deltam31.range = [-0.007, +0.007] * units.eV**2

#------------------------------------------------------------------------------
# Effective area
#------------------------------------------------------------------------------

[stage.aeff]

# instantiation arguments

input_binning = fitter_checks_true
output_binning = fitter_checks_true

particles = neutrinos
input_names = nue, nuebar, numu, numubar, nutau, nutaubar
#transform_groups = nuall_nc, nuallbar_nc
transform_groups = None
sum_grouped_flavints = True

error_method = None
debug_mode = False

# params

param.aeff_weight_file = events/deepcore_ic86/MSU/1XXXX/UnJoined/events__deepcore__IC86__runs_126001-126003,146001-146003,166001-166003__proc_v5digit__unjoined_with_fluxes_GENIE_Barr.hdf5

param.livetime = 2.5 units.common_year

param.aeff_scale = 1. +/- 0.1
param.aeff_scale.fixed = False
param.aeff_scale.range = nominal + [-0.3, +0.3]

param.nutau_cc_norm = 1.
param.nutau_cc_norm.fixed = False
param.nutau_cc_norm.prior = uniform
param.nutau_cc_norm.range = [-1.0, 3.0] * units.dimensionless

#------------------------------------------------------------------------------
# Reconstruction
#------------------------------------------------------------------------------

[stage.reco]

# instantiation arguments

input_binning = fitter_checks_true
output_binning = fitter_checks_reco

particles = neutrinos
input_names = nue_cc, numu_cc, nutau_cc, nuebar_cc, numubar_cc, nutaubar_cc, nue_nc, numu_nc, nutau_nc, nuebar_nc, numubar_nc, nutaubar_nc
transform_groups = nue_cc+nuebar_cc, numu_cc+numubar_cc, nutau_cc+nutaubar_cc, nuall_nc+nuallbar_nc

error_method = None
debug_mode = False

# params

param.reco_weight_file = events/deepcore_ic86/MSU/1XXXX/Joined/events__deepcore__IC86__runs_126001-126003,146001-146003,166001-166003__proc_v5digit__joined_G_nue_cc+nuebar_cc_G_numu_cc+numubar_cc_G_nutau_cc+nutaubar_cc_G_nuall_nc+nuallbar_nc.hdf5
param.reco_weights_name = None

# NOT IMPLEMENTED YET...
#param.e_reco_scale = 1. +/- 0.02
#param.e_reco_scale.fixed = False
#param.e_reco_scale.range = nominal + [-5., +5.] * sigma

#param.cz_reco_scale = 1. +/- 0.02
#param.cz_reco_scale.fixed = False
#param.cz_reco_scale.range = nominal + [-5., +5.] * sigma

#------------------------------------------------------------------------------
# Particle identification
#------------------------------------------------------------------------------

[stage.pid]

# instantiation arguments

input_binning = fitter_checks_reco
output_binning = fitter_checks_reco

particles = neutrinos
input_names = ${stage|reco:input_names}
transform_groups = nue_cc+nuebar_cc, numu_cc+numubar_cc, nutau_cc+nutaubar_cc, nuall_nc+nuallbar_nc

error_method = None
debug_mode = False

#energy_smooth = pid/pingu_v39/pid_energy_smooth__pingu_v39__runs_620-622__proc_5.1__pid_1.json
#signatures = all

# params

param.pid_events = events/deepcore_ic86/MSU/1XXXX/Joined/events__deepcore__IC86__runs_126001-126003,146001-146003,166001-166003__proc_v5digit__joined_G_nue_cc+nuebar_cc_G_numu_cc+numubar_cc_G_nutau_cc+nutaubar_cc_G_nuall_nc+nuallbar_nc.hdf5
param.pid_ver = msu_mn8d-mn7d
param.pid_remove_true_downgoing = False
param.pid_spec = None
param.pid_spec_source = pid/pid_specifications.json
param.pid_weights_name = None
#param.energy_offset = 0.
#param.energy_scale = 1.

#------------------------------------------------------------------------------
# Define names for common things to use in the above
#------------------------------------------------------------------------------

[fitter_checks]

# Atmospheric mixing parameters used for samples comparison
theta12 = 33.460498694345453 units.deg

theta13 = 8.490662585025774 +/- 0.205 units.deg

theta23 = 42.245560664398468 units.deg

deltacp = 306 units.deg

deltam21 = 7.5e-5 units.eV**2

deltam31 = 0.002457  units.eV**2
